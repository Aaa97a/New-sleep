<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>URL 書き換えルール 永続デモ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f8f8f8;
      color: #333;
    }
    h1 { font-size: 1.5rem; }
    form { 
      margin-bottom: 1.5rem; 
      padding: 1rem; 
      background-color: #fff; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
    }
    .form-group { margin: 0.5rem 0; }
    label { margin-left: 0.5rem; }
    input[type="text"] { width: 90%; padding: 0.5rem; font-size: 1rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; }
    .result { font-weight: bold; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>URL 書き換えルール の永続設定</h1>

  <!-- 設定フォーム：ラジオボタンでどの書き換えルールを使うか選択 -->
  <form id="configForm">
    <div class="form-group">
      <input type="radio" name="rewriteRule" id="none" value="none" checked>
      <label for="none">ルールなし</label>
    </div>
    <div class="form-group">
      <input type="radio" name="rewriteRule" id="watchToUme" value="watchToUme">
      <label for="watchToUme">/watch → /ume</label>
    </div>
    <div class="form-group">
      <input type="radio" name="rewriteRule" id="umeToW" value="umeToW">
      <label for="umeToW">/ume → /w</label>
    </div>
    <div class="form-group">
      <button type="button" onclick="applyRewrite()">設定を適用</button>
    </div>
  </form>

  <!-- 入力例：テキストボックスにURLを入力 -->
  <div class="form-group">
    <label for="inputUrl">元のURL:</label><br>
    <input type="text" id="inputUrl" value="https://example.com/watch/123">
  </div>
  <p class="result">書き換え後のURL: <span id="outputUrl">ここに結果が表示されます</span></p>

  <!-- ページ上のリンク例 ※こちらも自動で書き換えが適用されます -->
  <p class="form-group">
    ページ内のリンク例:
    <a href="https://example.com/watch/456" id="sampleLink">リンクを確認</a>
  </p>
  
  <!-- 任意に全リンクの書き換えを手動実行できるボタン -->
  <button onclick="applyRewriteToAnchors()">リンクを自動書き換え(再読み込み後も反映)</button>
  
  <script>
    // ① 初期設定：localStorageから保存されている書き換えルールを取得
    // 値がない場合は "none" がデフォルトになります
    var storedRule = localStorage.getItem('rewriteRule') || 'none';
    
    // rewriteConfig オブジェクト：true/falseで各ルールの有効/無効状態を管理
    var rewriteConfig = {
      watchToUme: (storedRule === 'watchToUme'),
      umeToW: (storedRule === 'umeToW')
    };

    // ② ページ読み込み時に、localStorage の設定に合わせてラジオボタンを更新
    document.addEventListener("DOMContentLoaded", function() {
      const radios = document.getElementsByName("rewriteRule");
      radios.forEach(function(radio) {
        if (radio.value === storedRule) {
          radio.checked = true;
        }
      });
      // ページ内のリンクにも、保存されている設定で自動書き換えを適用
      applyRewriteToAnchors();
    });
    
    // ③ 書き換え処理：条件に応じて URL の文字列を書き換える関数
    function rewriteUrl(url) {
      // 「/watch → /ume」ルールが有効の場合
      if (rewriteConfig.watchToUme && url.includes('/watch')) {
        return url.replace('/watch', '/ume');
      }
      // 「/ume → /w」ルールが有効の場合
      if (rewriteConfig.umeToW && url.includes('/ume')) {
        return url.replace('/ume', '/w');
      }
      return url;
    }

    // ④ 設定変更時に実行：ラジオボタンの値から rewriteConfig を更新し、localStorage に保存
    function applyRewrite() {
      var selectedRule = document.querySelector('input[name="rewriteRule"]:checked').value;
      if (selectedRule === "watchToUme") {
          rewriteConfig.watchToUme = true;
          rewriteConfig.umeToW = false;
      } else if (selectedRule === "umeToW") {
          rewriteConfig.watchToUme = false;
          rewriteConfig.umeToW = true;
      } else {
          rewriteConfig.watchToUme = false;
          rewriteConfig.umeToW = false;
      }
      // localStorage に設定値を保存しておけば、ページ再読み込み後も反映されます
      localStorage.setItem('rewriteRule', selectedRule);
      
      // 入力URLを書き換え、結果を表示
      var originalUrl = document.getElementById("inputUrl").value;
      var updatedUrl = rewriteUrl(originalUrl);
      document.getElementById("outputUrl").textContent = updatedUrl;
      
      // ページ内のリンクにも同じ書き換えルールを適用
      applyRewriteToAnchors();
    }
    
    // ⑤ ページ内の全リンク(アンカータグ)の href に対して書き換えルールを適用する関数
    function applyRewriteToAnchors() {
      // ページ内のすべてのアンカーリンクを取得
      var anchors = document.querySelectorAll('a');
      anchors.forEach(function(anchor) {
        // 既にオリジナル値を保持していなければ、data-original-href 属性に保存
        var originalHref = anchor.getAttribute('data-original-href') || anchor.href;
        anchor.setAttribute('data-original-href', originalHref);
        var updatedHref = rewriteUrl(originalHref);
        anchor.href = updatedHref;
      });
    }
  </script>
</body>
</html>


